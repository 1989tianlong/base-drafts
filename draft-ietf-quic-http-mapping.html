<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>HTTP/2 Semantics Using The QUIC Transport Protocol</title>

  <style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc, ul.toc ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Notational Conventions"/>
<link href="#rfc.section.2" rel="Chapter" title="2 QUIC advertisement"/>
<link href="#rfc.section.3" rel="Chapter" title="3 Connection establishment"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Sending a request on an HTTP/2-over-QUIC connection"/>
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Terminating a stream"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Writing data to QUIC streams"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Stream Mapping"/>
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Reserved Streams"/>
<link href="#rfc.section.6.1.1" rel="Chapter" title="6.1.1 Stream 3: headers"/>
<link href="#rfc.section.6.1.2" rel="Chapter" title="6.1.2 Stream states"/>
<link href="#rfc.section.7" rel="Chapter" title="7 Stream Priorities"/>
<link href="#rfc.section.8" rel="Chapter" title="8 Flow Control"/>
<link href="#rfc.section.9" rel="Chapter" title="9 Server Push"/>
<link href="#rfc.section.10" rel="Chapter" title="10 Error Codes"/>
<link href="#rfc.section.11" rel="Chapter" title="11 Other HTTP/2 frames"/>
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 GOAWAY frame"/>
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 PING frame"/>
<link href="#rfc.section.11.3" rel="Chapter" title="11.3 PADDING frame"/>
<link href="#rfc.section.12" rel="Chapter" title="12 Security Considerations"/>
<link href="#rfc.section.13" rel="Chapter" title="13 IANA Considerations"/>
<link href="#rfc.references" rel="Chapter" title="14 Normative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.2 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Shade, R. and M. Warres" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-quic-http-mapping-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2016-11-22" />
  <meta name="dct.abstract" content="The QUIC transport protocol has several features that are desirable in a transport for HTTP/2, such as stream multiplexing, per-stream flow control, and low-latency connection establishment.  This document describes a mapping of HTTP/2 semantics over QUIC.  Specifically, this document identifies HTTP/2 features that are subsumed by QUIC, and describes how the other features can be implemented atop QUIC." />
  <meta name="description" content="The QUIC transport protocol has several features that are desirable in a transport for HTTP/2, such as stream multiplexing, per-stream flow control, and low-latency connection establishment.  This document describes a mapping of HTTP/2 semantics over QUIC.  Specifically, this document identifies HTTP/2 features that are subsumed by QUIC, and describes how the other features can be implemented atop QUIC." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">Network Working Group</td>
  <td class="right">R. Shade</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">M. Warres</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">Google</td>
</tr>
<tr>
  <td class="left">Expires: May 26, 2017</td>
  <td class="right">November 22, 2016</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">HTTP/2 Semantics Using The QUIC Transport Protocol<br />
  <span class="filename">draft-ietf-quic-http-mapping-latest</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>The QUIC transport protocol has several features that are desirable in a transport for HTTP/2, such as stream multiplexing, per-stream flow control, and low-latency connection establishment.  This document describes a mapping of HTTP/2 semantics over QUIC.  Specifically, this document identifies HTTP/2 features that are subsumed by QUIC, and describes how the other features can be implemented atop QUIC.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 26, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2016 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Notational Conventions</a></li>
</ul><li>2.   <a href="#rfc.section.2">QUIC advertisement</a></li>
<li>3.   <a href="#rfc.section.3">Connection establishment</a></li>
<li>4.   <a href="#rfc.section.4">Sending a request on an HTTP/2-over-QUIC connection</a></li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Terminating a stream</a></li>
</ul><li>5.   <a href="#rfc.section.5">Writing data to QUIC streams</a></li>
<li>6.   <a href="#rfc.section.6">Stream Mapping</a></li>
<ul><li>6.1.   <a href="#rfc.section.6.1">Reserved Streams</a></li>
<ul><li>6.1.1.   <a href="#rfc.section.6.1.1">Stream 3: headers</a></li>
<li>6.1.2.   <a href="#rfc.section.6.1.2">Stream states</a></li>
</ul></ul><li>7.   <a href="#rfc.section.7">Stream Priorities</a></li>
<li>8.   <a href="#rfc.section.8">Flow Control</a></li>
<li>9.   <a href="#rfc.section.9">Server Push</a></li>
<li>10.   <a href="#rfc.section.10">Error Codes</a></li>
<li>11.   <a href="#rfc.section.11">Other HTTP/2 frames</a></li>
<ul><li>11.1.   <a href="#rfc.section.11.1">GOAWAY frame</a></li>
<li>11.2.   <a href="#rfc.section.11.2">PING frame</a></li>
<li>11.3.   <a href="#rfc.section.11.3">PADDING frame</a></li>
</ul><li>12.   <a href="#rfc.section.12">Security Considerations</a></li>
<li>13.   <a href="#rfc.section.13">IANA Considerations</a></li>
<li>14.   <a href="#rfc.references">Normative References</a></li>
<li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a></h1>
<p id="rfc.section.1.p.1">The QUIC transport protocol has several features that are desirable in a transport for HTTP/2, such as stream multiplexing, per-stream flow control, and low-latency connection establishment.  This document describes a mapping of HTTP/2 semantics over QUIC.  Specifically, this document identifies HTTP/2 features that are subsumed by QUIC, and describes how the other features can be implemented atop QUIC.</p>
<p id="rfc.section.1.p.2">QUIC is described in <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a>.  For a full description of HTTP/2, see <a href="#RFC7540">[RFC7540]</a>.</p>
<h2 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#notational-conventions" id="notational-conventions">Notational Conventions</a></h2>
<p id="rfc.section.1.1.p.1">The words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;SHOULD&#8221;, and &#8220;MAY&#8221; are used in this document.  It&#8217;s not shouting; when they are capitalized, they have the special meaning defined in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#quic-advertisement" id="quic-advertisement">QUIC advertisement</a></h1>
<p id="rfc.section.2.p.1">A server advertises that it can speak HTTP/2-over-QUIC via the Alt- Svc HTTP response header.  It does so by including the header in any response sent over a non-QUIC (e.g.  HTTP/2 over TLS) connection:</p>
<p id="rfc.section.2.p.2">Alt-Svc: quic=&#8221;:443&#8221;</p>
<p id="rfc.section.2.p.3">In addition, the list of QUIC versions supported by the server can be specified by the v= parameter.  For example, if a server supported both version 33 and 34 it would specify the following header:</p>
<p id="rfc.section.2.p.4">Alt-Svc: quic=&#8221;:443&#8221;; v=&#8221;34,33&#8221;</p>
<p id="rfc.section.2.p.5">On receipt of this header, a client may attempt to establish a QUIC connection on port 443 and, if successful, send HTTP/2 requests using the mapping described in this document.</p>
<p id="rfc.section.2.p.6">Connectivity problems (e.g. firewall blocking UDP) may result in QUIC connection establishment failure, in which case the client should gracefully fallback to HTTP/2-over-TLS/TCP.</p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#connection-establishment" id="connection-establishment">Connection establishment</a></h1>
<p id="rfc.section.3.p.1">HTTP/2-over-QUIC connections are established as described in <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a>.  The QUIC crypto handshake MUST use TLS <a href="#QUIC-TLS">[QUIC-TLS]</a>.</p>
<p id="rfc.section.3.p.2">While connection-level options pertaining to the core QUIC protocol are set in the initial crypto handshake <a href="#QUIC-TLS">[QUIC-TLS]</a>.  HTTP/2-specific settings are conveyed in the HTTP/2 SETTINGS frame.  After the QUIC connection is established, an HTTP/2 SETTINGS frame may be sent as the initial frame of the QUIC headers stream (StreamID 3, See <a href="#stream-mapping">Section 6</a>). As in HTTP/2, additional SETTINGS frames may be sent mid-connection by either endpoint.</p>
<p id="rfc.section.3.p.3">TODO: decide whether to acknowledge receipt of SETTINGS through empty SETTINGS frames with ACK bit set, as in HTTP/2, or rely on transport- level acknowledgment.</p>
<p id="rfc.section.3.p.4">Some transport-level options that HTTP/2-over-TCP specifies via the SETTINGS frame are superseded by QUIC transport parameters in HTTP/2- over-QUIC.  Below is a listing of how each HTTP/2 SETTINGS parameter is mapped:</p>
<p/>

<dl>
  <dt>SETTINGS_HEADER_TABLE_SIZE:</dt>
  <dd style="margin-left: 8">Sent in HTTP/2 SETTINGS frame.</dd>
  <dt>SETTINGS_ENABLE_PUSH:</dt>
  <dd style="margin-left: 8">Sent in HTTP/2 SETTINGS frame (TBD, currently set using QUIC &#8220;SPSH&#8221; connection option)</dd>
  <dt>SETTINGS_MAX_CONCURRENT_STREAMS</dt>
  <dd style="margin-left: 8">QUIC requires the maximum number of incoming streams per connection to be specified in the initial crypto handshake, using the &#8220;MSPC&#8221; tag.  Specifying SETTINGS_MAX_CONCURRENT_STREAMS in the HTTP/2 SETTINGS frame is an error.</dd>
  <dt>SETTINGS_INITIAL_WINDOW_SIZE:</dt>
  <dd style="margin-left: 8">QUIC requires both stream and connection flow control window sizes to be specified in the initial crypto handshake, using the &#8220;SFCW&#8221; and &#8220;CFCW&#8221; tags, respectively.  Specifying SETTINGS_INITIAL_WINDOW_SIZE in the HTTP/2 SETTINGS frame is an error.</dd>
  <dt>SETTINGS_MAX_FRAME_SIZE:</dt>
  <dd style="margin-left: 8">This setting has no equivalent in QUIC.  Specifying it in the HTTP/2 SETTINGS frame is an error.</dd>
  <dt>SETTINGS_MAX_HEADER_LIST_SIZE</dt>
  <dd style="margin-left: 8">Sent in HTTP/2 SETTINGS frame.</dd>
</dl>
<p id="rfc.section.3.p.6">As with HTTP/2-over-TCP, unknown SETTINGS parameters are tolerated but ignored.  SETTINGS parameters are acknowledged by the receiving peer, by sending an empty SETTINGS frame in response with the ACK bit set.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#sending-a-request-on-an-http2-over-quic-connection" id="sending-a-request-on-an-http2-over-quic-connection">Sending a request on an HTTP/2-over-QUIC connection</a></h1>
<p id="rfc.section.4.p.1">A high level overview of sending an HTTP/2 request on an established QUIC connection is as follows, with further details in later sections of this document.  A client should first encode any HTTP headers using HPACK <a href="#RFC7541">[RFC7541]</a> and frame them as HTTP/2 HEADERS frames.  These are sent on StreamID 3 (see <a href="#stream-mapping">Section 6</a>).  The exact layout of the HEADERS frame is described in Section 6.2 of <a href="#RFC7540">[RFC7540]</a>.  No HTTP/2 padding is required: QUIC provides a PADDING frame for this purpose.</p>
<p id="rfc.section.4.p.2">While HEADERS are sent on stream 3, the mandatory stream identifier in each HEADERS frame indicates the QUIC StreamID on which a corresponding request body may be sent.  If there is no non-header data, the specified QUIC data stream will never be used.</p>
<h2 id="rfc.section.4.1"><a href="#rfc.section.4.1">4.1.</a> <a href="#terminating-a-stream" id="terminating-a-stream">Terminating a stream</a></h2>
<p id="rfc.section.4.1.p.1">A stream can be terminated in one of three ways:</p>
<p/>

<ul>
  <li>the request/response is headers only, in which case a HEADERS frame with the END_STREAM bit set ends the stream specified in the HEADERS frame</li>
  <li>the request/response has headers and body but no trailing headers, in which case the final QUIC STREAM frame will have the FIN bit set</li>
  <li>the request/response has headers, body, and trailing headers, in which case the final QUIC STREAM frame will not have the FIN bit set, and the trailing HEADERS frame will have the END_STREAM bit set</li>
</ul>
<p id="rfc.section.4.1.p.3">(TODO: Describe mapping of HTTP/2 stream state machine to QUIC stream state machine.)</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#writing-data-to-quic-streams" id="writing-data-to-quic-streams">Writing data to QUIC streams</a></h1>
<p id="rfc.section.5.p.1">A QUIC stream provides reliable in-order delivery of bytes, within that stream.  On the wire, data is framed into QUIC STREAM frames, but this framing is invisible to the HTTP/2 layer.  A QUIC receiver buffers and orders received STREAM frames, exposing the data contained within as a reliable byte stream to the application.</p>
<p id="rfc.section.5.p.2">Bytes written to Stream 3 must be HTTP/2 HEADERS frames (or other HTTP/2 non-data frames), whereas bytes written to data streams should simply be request or response bodies.  No further framing is required by HTTP/2 (i.e. no HTTP/2 DATA frames are used).</p>
<p id="rfc.section.5.p.3">If data arrives on a data stream before the corresponding HEADERS have arrived on stream 3, then the data is buffered until the HEADERS arrive.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#stream-mapping" id="stream-mapping">Stream Mapping</a></h1>
<p id="rfc.section.6.p.1">When HTTP/2 headers and data are sent over QUIC, the QUIC layer handles most of the stream management.  HTTP/2 StreamIDs are replaced by QUIC StreamIDs.  HTTP/2 does not need to do any explicit stream framing when using QUIC - data sent over a QUIC stream simply consists of HTTP/2 headers or body.  Requests and responses are considered complete when the QUIC stream is closed in the corresponding direction.</p>
<p id="rfc.section.6.p.2">Like HTTP/2, QUIC uses odd-numbered StreamIDs for client initiated streams, and even-numbered IDs for server initiated (i.e. server push) streams.  Unlike HTTP/2 there are a couple of reserved (or dedicated) StreamIDs in QUIC.</p>
<h2 id="rfc.section.6.1"><a href="#rfc.section.6.1">6.1.</a> <a href="#reserved-streams" id="reserved-streams">Reserved Streams</a></h2>
<p id="rfc.section.6.1.p.1">StreamID 1 is reserved for crypto operations (the handshake, crypto config updates), and MUST NOT be used for HTTP/2 headers or body, see <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a>.  StreamID 3 is reserved for sending and receiving HTTP/2 HEADERS frames.  Therefore the first client initiated data stream has StreamID 5.</p>
<p id="rfc.section.6.1.p.2">There are no reserved server initiated StreamIDs, so the first server initiated (i.e. server push) stream has an ID of 2, followed by 4, etc.</p>
<h3 id="rfc.section.6.1.1"><a href="#rfc.section.6.1.1">6.1.1.</a> <a href="#stream-3-headers" id="stream-3-headers">Stream 3: headers</a></h3>
<p id="rfc.section.6.1.1.p.1">HTTP/2-over-QUIC uses HPACK header compression as described in <a href="#RFC7541">[RFC7541]</a>.  HPACK was designed for HTTP/2 with the assumption of in- order delivery such as that provided by TCP.  A sequence of encoded header blocks must arrive (and be decoded) at an endpoint in the same order in which they were encoded.  This ensures that the dynamic state at the two endpoints remains in sync.</p>
<p id="rfc.section.6.1.1.p.2">QUIC streams provide in-order delivery of data sent on those streams, but there are no guarantees about order of delivery between streams.  To achieve in-order delivery of HEADERS frames in QUIC, they are all sent on the reserved Stream 3.  Data (request/response bodies) which arrive on other data streams are buffered until the corresponding HEADERS arrive and are read out of Stream 3.</p>
<p id="rfc.section.6.1.1.p.3">This does introduce head-of-line blocking: if the packet containing HEADERS for stream N is lost or reordered then stream N+2 cannot be processed until they it has been retransmitted successfully, even though the HEADERS for stream N+2 may have arrived.</p>
<p id="rfc.section.6.1.1.p.4">Trailing headers (trailers) can also be sent on stream 3.  These are sent as HTTP/2 HEADERS frames, but MUST have the END_STREAM bit set, and MUST include a &#8220;:final-offset&#8221; pseudo-header.  Since QUIC supports out of order delivery, receipt of a HEADERS frame with the END_STREAM bit set does not guarantee that the entire request/ response body has been fully received.  Therefore, the extra &#8220;:final-offset&#8221; pseudo-header is included in trailing HEADERS frames to indicate the total number of body bytes sent on the corresponding data stream.  This is used by the QUIC layer to determine when the full request has been received and therefore when it is safe to tear down local stream state.  The &#8220;:final-offset&#8221; pseudo header is stripped from the HEADERS before passing to the HTTP/2 layer.</p>
<h3 id="rfc.section.6.1.2"><a href="#rfc.section.6.1.2">6.1.2.</a> <a href="#stream-states" id="stream-states">Stream states</a></h3>
<p id="rfc.section.6.1.2.p.1">The mapping of HTTP/2-over-QUIC with potential out of order delivery of HEADERS frames results in some changes to the HTTP/2 stream state transition diagram (<a href="#RFC7540">[RFC7540]</a>, Section 5.1}}.  Specifically the transition from &#8220;open&#8221; to &#8220;half closed (remote)&#8221;, and the transition from &#8220;half closed (local)&#8221; to &#8220;closed&#8221; takes place only when:</p>
<p/>

<ul>
  <li>the peer has explicitly ended the stream via either  <ul><li>an HTTP/2 HEADERS frame with END_STREAM bit set and, in the case of trailing headers, the :final-offset pseudo-header</li><li>or a QUIC stream frame with the FIN bit set.</li></ul></li>
  <li>and the full request or response body has been received.</li>
</ul>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#stream-priorities" id="stream-priorities">Stream Priorities</a></h1>
<p id="rfc.section.7.p.1">HTTP/2-over-QUIC uses the HTTP/2 priority scheme described in <a href="#RFC7540">[RFC7540]</a> Section 5.3.  In the HTTP/2 priority scheme, a given stream can be designated as dependent upon another stream, which expresses the preference that the latter stream (the &#8220;parent&#8221; stream) be allocated resources before the former stream (the &#8220;dependent&#8221; stream).  Taken together, the dependencies across all streams in a connection form a dependency tree.  The structure of the dependency tree changes as HTTP/2 HEADERS and PRIORITY frames add, remove, or change the dependency links between streams.</p>
<p id="rfc.section.7.p.2">Implicit in this scheme is the notion of in-order delivery of priority changes (i.e., dependency tree mutations): since operations on the dependency tree such as reparenting a subtree are not commutative, both sender and receiver must apply them in the same order to ensure that both sides have a consistent view of the stream dependency tree.  HTTP/2 specifies priority assignments in PRIORITY frames and (optionally) in HEADERS frames.  To achieve in-order delivery of HTTP/2 priority changes in HTTP/2-over-QUIC, HTTP/2 PRIORITY frames, in addition to HEADERS frames, are also sent on reserved stream 3.  The semantics of the Stream Dependency, Weight, E flag, and (for HEADERS frames) PRIORITY flag are the same as in HTTP/2-over-TCP.</p>
<p id="rfc.section.7.p.3">Since HEADERS and PRIORITY frames are sent on a different stream than the STREAM frames for the streams they reference, they may be delivered out-of-order with respect to the STREAM frames.  There is no special handling for this&#8211;the receiver should simply assign resources according to the most recent stream priority information that it has received.</p>
<p id="rfc.section.7.p.4">ALTERNATIVE DESIGN: if the core QUIC protocol implements priorities, then this document should map the HTTP/2 priorities scheme to that provided by the core protocol.  This would likely involve prohibiting the sending of HTTP/2 PRIORITY frames and setting of the PRIORITY flag in HTTP/2 HEADERS frames, to avoid conflicting directives.</p>
<h1 id="rfc.section.8"><a href="#rfc.section.8">8.</a> <a href="#flow-control" id="flow-control">Flow Control</a></h1>
<p id="rfc.section.8.p.1">QUIC provides stream and connection level flow control, similar in principle to HTTP/2&#8217;s flow control but with some implementation differences.  As flow control is handled by QUIC, the HTTP/2 mapping need not concern itself with maintaining flow control state, or how/ when to send flow control frames to the peer.  The HTTP/2 mapping must not send HTTP/2 WINDOW_UPDATE frames.</p>
<p id="rfc.section.8.p.2">The initial flow control window sizes (stream and connection) are communicated during the crypto handshake (see <a href="#connection-establishment">Section 3</a>).  Setting these values to the maximum size (2^31 - 1) effectively disables flow control.</p>
<p id="rfc.section.8.p.3">Relatively small initial windows can be used, as QUIC will attempt to auto-tune the flow control windows based on usage.  See <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a> for more details.</p>
<h1 id="rfc.section.9"><a href="#rfc.section.9">9.</a> <a href="#server-push" id="server-push">Server Push</a></h1>
<p id="rfc.section.9.p.1">HTTP/2-over-QUIC supports HTTP/2 server push.  During connection establishment, the client indicates whether or it is willing to receive server pushes via the SETTINGS_ENABLE_PUSH setting in the HTTP/2 SETTINGS frame (see <a href="#connection-establishment">Section 3</a>), which defaults to 1 (true).</p>
<p id="rfc.section.9.p.2">As with server push for HTTP/2-over-TCP, the server initiates a server push by sending an HTTP/2 PUSH_PROMISE frame containing the StreamID of the stream to be pushed, as well as request header fields attributed to the request.  The PUSH_PROMISE frame is sent on stream 3, to ensure proper ordering with respect to other HEADERS and non- data frames.  Within the PUSH_PROMISE frame, the StreamID in the common HTTP/2 frame header indicates the associated (client- initiated) stream for the new push stream, while the Promised Stream ID field specifies the StreamID of the new push stream.</p>
<p id="rfc.section.9.p.3">The server push response is conveyed in the same way as a non-server- push response, with response headers and (if present) trailers carried by HTTP/2 HEADERS frames sent on reserved stream 3, and response body (if any) sent via QUIC stream frames on the stream specified in the corresponding PUSH_PROMISE frame.</p>
<h1 id="rfc.section.10"><a href="#rfc.section.10">10.</a> <a href="#error-codes" id="error-codes">Error Codes</a></h1>
<p id="rfc.section.10.p.1">The HTTP/2 error codes defined in Section 7 of <a href="#RFC7540">[RFC7540]</a> map to QUIC error codes as follows:</p>
<p/>

<dl>
  <dt>NO_ERROR (0x0):</dt>
  <dd style="margin-left: 8">Maps to QUIC_NO_ERROR</dd>
  <dt>PROTOCOL_ERROR (0x1):</dt>
  <dd style="margin-left: 8">No single mapping?</dd>
  <dt>INTERNAL_ERROR (0x2)</dt>
  <dd style="margin-left: 8">QUIC_INTERNAL_ERROR? (not currently defined in core protocol spec)</dd>
  <dt>FLOW_CONTROL_ERROR (0x3):</dt>
  <dd style="margin-left: 8">QUIC_FLOW_CONTROL_RECEIVED_TOO_MUCH_DATA? (not currently defined in core protocol spec)</dd>
  <dt>SETTINGS_TIMEOUT (0x4):</dt>
  <dd style="margin-left: 8">(depends on whether we support SETTINGS acks)</dd>
  <dt>STREAM_CLOSED (0x5):</dt>
  <dd style="margin-left: 8">QUIC_STREAM_DATA_AFTER_TERMINATION</dd>
  <dt>FRAME_SIZE_ERROR (0x6)</dt>
  <dd style="margin-left: 8">QUIC_INVALID_FRAME_DATA</dd>
  <dt>REFUSED_STREAM (0x7):</dt>
  <dd style="margin-left: 8">?</dd>
  <dt>CANCEL (0x8):</dt>
  <dd style="margin-left: 8">?</dd>
  <dt>COMPRESSION_ERROR (0x9):</dt>
  <dd style="margin-left: 8">QUIC_DECOMPRESSION_FAILURE (not currently defined in core spec)</dd>
  <dt>CONNECT_ERROR (0xa):</dt>
  <dd style="margin-left: 8">? (depends whether we decide to support CONNECT)</dd>
  <dt>ENHANCE_YOUR_CALM (0xb):</dt>
  <dd style="margin-left: 8">?</dd>
  <dt>INADEQUATE_SECURITY (0xc):</dt>
  <dd style="margin-left: 8">QUIC_HANDSHAKE_FAILED, QUIC_CRYPTO_NO_SUPPORT</dd>
  <dt>HTTP_1_1_REQUIRED (0xd):</dt>
  <dd style="margin-left: 8">?</dd>
</dl>
<p id="rfc.section.10.p.3">TODO: fill in missing error code mappings.</p>
<h1 id="rfc.section.11"><a href="#rfc.section.11">11.</a> <a href="#other-http2-frames" id="other-http2-frames">Other HTTP/2 frames</a></h1>
<p id="rfc.section.11.p.1">QUIC includes some features (e.g. flow control) which are also present in HTTP/2.  In these cases the HTTP/2 mapping need not re- implement them.  As a result some HTTP/2 frame types are not required when using QUIC, as they either are directly implemented in the QUIC layer, or their functionality is provided via other means.  This section of the document describes these cases.</p>
<h2 id="rfc.section.11.1"><a href="#rfc.section.11.1">11.1.</a> <a href="#goaway-frame" id="goaway-frame">GOAWAY frame</a></h2>
<p id="rfc.section.11.1.p.1">QUIC has its own GOAWAY frame, and QUIC implementations may to expose the sending of a GOAWAY to the application.  The semantics of sending a GOAWAY in QUIC are identical to HTTP/2: an endpoint sending a GOAWAY will continue processing open streams, but will not accept newly created streams.</p>
<p id="rfc.section.11.1.p.2">QUIC&#8217;s GOAWAY frame is described in detail in the <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a>.</p>
<h2 id="rfc.section.11.2"><a href="#rfc.section.11.2">11.2.</a> <a href="#ping-frame" id="ping-frame">PING frame</a></h2>
<p id="rfc.section.11.2.p.1">QUIC has its own PING frame, which is currently exposed to the application.  QUIC clients send periodic PINGs to servers if there are no currently active data streams on the connection.</p>
<p id="rfc.section.11.2.p.2">QUIC&#8217;s PING frame is described in detail in the <a href="#QUIC-TRANSPORT">[QUIC-TRANSPORT]</a>.</p>
<h2 id="rfc.section.11.3"><a href="#rfc.section.11.3">11.3.</a> <a href="#padding-frame" id="padding-frame">PADDING frame</a></h2>
<p id="rfc.section.11.3.p.1">There is no HTTP/2 padding in this mapping; padding is instead provided at the QUIC layer by including QUIC PADDING frames in a packet payload.  An HTTP/2 over QUIC mapping should treat any HTTP/2 level padding as an error, to avoid any possibility of inconsistent flow control states between endpoints (e.g. client sends HTTP/2 padding, counts it against flow control, server ignores).</p>
<h1 id="rfc.section.12"><a href="#rfc.section.12">12.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a></h1>
<p id="rfc.section.12.p.1">The security considerations of HTTP over QUIC should be comparable to those of HTTP/2.</p>
<h1 id="rfc.section.13"><a href="#rfc.section.13">13.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a></h1>
<p id="rfc.section.13.p.1">This document has no IANA actions.  Yet.</p>
<h1 id="rfc.references"><a href="#rfc.references">14.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="QUIC-TLS">[QUIC-TLS]</b>
      </td>
      <td class="top"><a title="Mozilla">Thomson, M.</a> and <a title="sn3rd">S. Turner, Ed</a>, "<a>Using Transport Layer Security (TLS) to Secure QUIC</a>", November 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="QUIC-TRANSPORT">[QUIC-TRANSPORT]</b>
      </td>
      <td class="top"><a title="Google">Iyengar, J.</a> and <a title="Mozilla">M. Thomson</a>, "<a>QUIC: A UDP-Based Multiplexed and Secure Transport</a>", November 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7540">[RFC7540]</b>
      </td>
      <td class="top"><a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="http://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7541">[RFC7541]</b>
      </td>
      <td class="top"><a>Peon, R.</a> and <a>H. Ruellan</a>, "<a href="http://tools.ietf.org/html/rfc7541">HPACK: Header Compression for HTTP/2</a>", RFC 7541, DOI 10.17487/RFC7541, May 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Robbie Shade</span> 
	  <span class="n hidden">
		<span class="family-name">Shade</span>
	  </span>
	</span>
	<span class="org vcardline">Google</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:rjshade@google.com">rjshade@google.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mike Warres</span> 
	  <span class="n hidden">
		<span class="family-name">Warres</span>
	  </span>
	</span>
	<span class="org vcardline">Google</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mpw@google.com">mpw@google.com</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/quicwg/base-drafts">Fork me on GitHub</a></div></div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>QPACK: Header Compression for HTTP over QUIC</title>

  
<style type="text/css">/*<![CDATA[*/

body {
  font: 16px "Helvetica Neue","Open Sans",Helvetica,Calibri,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 24px;
  margin: 75px auto;
  max-width: 724px;
  padding: 0 5px;
}

.title, .filename, h1, h2, h3, h4, h5 {
  font: 16px "Helvetica Neue","Roboto Condensed","Open Sans",Helvetica,Calibri,sans-serif;
  font-size-adjust: 0.5;
  font-weight: bold;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title, #rfc\.title h1 { font-size: 32px; }
h1, section h1, h2, section h2, section h3, nav h2 { font-size: 20px; }
h3, section h4, h4, section h5 { font-size: 16px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header, table#rfc\.headerblock {
  width: 100%;
}
table.header td, table#rfc\.headerblock td {
  border: none;
  background-color: transparent;
  color: black;
  padding: 0;
}
.filename {
  display: block;
  color: rgb(119, 119, 119);
  font-size: 20px;
  font-weight: normal;
  line-height: 100%;
  margin: 10px 0 32px;
}
#rfc\.abstract+p, #rfc\.abstract p {
  font-size: 20px;
  line-height: 28px;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure, caption {
  font-style: italic;
  margin: 0 1.5em;
  text-align: left;
}

address {
  margin: 16px 2px;
  line-height: 20px;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn, address b {
  font-weight: normal;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}
hr.noprint {
  display: none;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

ul.toc ul {
  margin: 0 0 0 2em;
}
ul.toc li {
  list-style: none;
  margin: 0;
}

@media screen and (min-width: 1024px) {
  body {
    padding-right: 350px;
  }
  body>ul.toc, body>#rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 550px);
    width: 300px;
    z-index: 1;
    overflow: auto;
    overscroll-behavior: contain;
  }
  body>#rfc\.toc {
    top: 55px;
  }
  body>ul.toc {
    top: 100px;
  }

  ul.toc {
    margin: 0 0 0 4px;
    font-size: 12px;
    line-height: 20px;
  }
  ul.toc ul {
    margin-left: 1.2em;
  }
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>
  <meta name="viewport" content="initial-scale=1.0">


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Head-of-Line Blocking in HPACK">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Avoiding Head-of-Line Blocking in HTTP/QUIC">
<link href="#rfc.section.2" rel="Chapter" title="2 Wire Format">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Primitives">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Indexing">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 HEADERS Frames on the Control Stream">
<link href="#rfc.section.2.3.1" rel="Chapter" title="2.3.1 Insert With Name Reference">
<link href="#rfc.section.2.3.2" rel="Chapter" title="2.3.2 Insert Without Name Reference">
<link href="#rfc.section.2.3.3" rel="Chapter" title="2.3.3 Duplicate">
<link href="#rfc.section.2.3.4" rel="Chapter" title="2.3.4 Dynamic Table Size Update">
<link href="#rfc.section.2.4" rel="Chapter" title="2.4 HEADER_ACK Frames">
<link href="#rfc.section.2.5" rel="Chapter" title="2.5 Request Streams">
<link href="#rfc.section.2.5.1" rel="Chapter" title="2.5.1 Base Index Encoding">
<link href="#rfc.section.2.5.2" rel="Chapter" title="2.5.2 Instructions">
<link href="#rfc.section.3" rel="Chapter" title="3 Encoding Strategies">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Reference Tracking">
<link href="#rfc.section.3.1.1" rel="Chapter" title="3.1.1 Blocked Eviction">
<link href="#rfc.section.3.1.2" rel="Chapter" title="3.1.2 Blocked Decoding">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Speculative table updates">
<link href="#rfc.section.4" rel="Chapter" title="4 Security Considerations">
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="6 References">
<link href="#rfc.references.1" rel="Chapter" title="6.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="6.2 Informative References">
<link href="#rfc.acknowledgments" rel="Chapter">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.9.6 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Krasic, C., Bishop, M., and A. Frindell, Ed." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-quic-qpack-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2018-04-26" />
  <meta name="dct.abstract" content="This specification defines QPACK, a compression format for efficiently representing HTTP header fields, to be used in HTTP over QUIC. This is a variation of HPACK header compression that seeks to reduce head-of-line blocking." />
  <meta name="description" content="This specification defines QPACK, a compression format for efficiently representing HTTP header fields, to be used in HTTP over QUIC. This is a variation of HPACK header compression that seeks to reduce head-of-line blocking." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">QUIC</td>
<td class="right">C. Krasic</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Google, Inc</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">M. Bishop</td>
</tr>
<tr>
<td class="left">Expires: October 28, 2018</td>
<td class="right">Akamai Technologies</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">A. Frindell, Ed.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Facebook</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">April 26, 2018</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">QPACK: Header Compression for HTTP over QUIC<br />
  <span class="filename">draft-ietf-quic-qpack-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This specification defines QPACK, a compression format for efficiently representing HTTP header fields, to be used in HTTP over QUIC. This is a variation of HPACK header compression that seeks to reduce head-of-line blocking.</p>
<h1><a>Note to Readers</a></h1>
<p>Discussion of this draft takes place on the QUIC working group mailing list (quic@ietf.org), which is archived at <a href="https://mailarchive.ietf.org/arch/search/?email_list=quic">https://mailarchive.ietf.org/arch/search/?email_list=quic</a>.</p>
<p>Working Group information can be found at <a href="https://github.com/quicwg">https://github.com/quicwg</a>; source code and issues list for this draft can be found at <a href="https://github.com/quicwg/base-drafts/labels/-qpack">https://github.com/quicwg/base-drafts/labels/-qpack</a>.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at https://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on October 28, 2018.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2018 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (https://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Head-of-Line Blocking in HPACK</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Avoiding Head-of-Line Blocking in HTTP/QUIC</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Wire Format</a>
</li>
<ul><li>2.1.   <a href="#rfc.section.2.1">Primitives</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Indexing</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">HEADERS Frames on the Control Stream</a>
</li>
<ul><li>2.3.1.   <a href="#rfc.section.2.3.1">Insert With Name Reference</a>
</li>
<li>2.3.2.   <a href="#rfc.section.2.3.2">Insert Without Name Reference</a>
</li>
<li>2.3.3.   <a href="#rfc.section.2.3.3">Duplicate</a>
</li>
<li>2.3.4.   <a href="#rfc.section.2.3.4">Dynamic Table Size Update</a>
</li>
</ul><li>2.4.   <a href="#rfc.section.2.4">HEADER_ACK Frames</a>
</li>
<li>2.5.   <a href="#rfc.section.2.5">Request Streams</a>
</li>
<ul><li>2.5.1.   <a href="#rfc.section.2.5.1">Base Index Encoding</a>
</li>
<li>2.5.2.   <a href="#rfc.section.2.5.2">Instructions</a>
</li>
</ul></ul><li>3.   <a href="#rfc.section.3">Encoding Strategies</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Reference Tracking</a>
</li>
<ul><li>3.1.1.   <a href="#rfc.section.3.1.1">Blocked Eviction</a>
</li>
<li>3.1.2.   <a href="#rfc.section.3.1.2">Blocked Decoding</a>
</li>
</ul><li>3.2.   <a href="#rfc.section.3.2">Speculative table updates</a>
</li>
</ul><li>4.   <a href="#rfc.section.4">Security Considerations</a>
</li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a>
</li>
<li>6.   <a href="#rfc.references">References</a>
</li>
<ul><li>6.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>6.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li><a href="#rfc.acknowledgments">Acknowledgments</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">The QUIC transport protocol was designed from the outset to support HTTP semantics, and its design subsumes many of the features of HTTP/2.  QUIC&#8217;s stream multiplexing comes into some conflict with  header compression.  A key goal of the design of QUIC is to improve stream multiplexing relative to HTTP/2 by eliminating HoL (head of line) blocking, which can occur in HTTP/2.  HoL blocking can happen because all HTTP/2 streams are multiplexed onto a single TCP connection with its in-order semantics.  QUIC can maintain independence between streams because it implements core transport functionality in a fully stream-aware manner.  However, the HTTP/QUIC mapping is still subject to HoL blocking if HPACK is used directly.  HPACK exploits multiplexing for greater compression, shrinking the representation of headers that have appeared earlier on the same connection.  In the context of QUIC, this imposes a vulnerability to HoL blocking (see <a href="#hol-example" class="xref">Section 1.1</a>).</p>
<p id="rfc.section.1.p.2">QUIC is described in <a href="#QUIC-TRANSPORT" class="xref">[QUIC-TRANSPORT]</a>.  The HTTP/QUIC mapping is described in <a href="#QUIC-HTTP" class="xref">[QUIC-HTTP]</a>. For a full description of HTTP/2, see <a href="#RFC7540" class="xref">[RFC7540]</a>. The description of HPACK is <a href="#RFC7541" class="xref">[RFC7541]</a>, with important terminology in Section 1.3.</p>
<p id="rfc.section.1.p.3">QPACK modifies HPACK to allow correctness in the presence of out-of-order delivery, with flexibility for implementations to balance between resilience against HoL blocking and optimal compression ratio.  The design goals are to closely approach the compression ratio of HPACK with substantially less head-of-line blocking under the same loss conditions.</p>
<p id="rfc.section.1.p.4">QPACK is intended to be a relatively non-intrusive extension to HPACK; an implementation should be easily shared within stacks supporting both HTTP/2 over (TLS+)TCP and HTTP/QUIC.</p>
<h2 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#hol-example" id="hol-example">Head-of-Line Blocking in HPACK</a>
</h2>
<p id="rfc.section.1.1.p.1">HPACK enables several types of header representations, one of which also adds the header to a dynamic table of header values.  These values are then available for reuse in subsequent header blocks simply by referencing the entry number in the table.</p>
<p id="rfc.section.1.1.p.2">If the packet containing a header is lost, that stream cannot complete header processing until the packet is retransmitted.  This is unavoidable. However, other streams which rely on the state created by that packet <em>also</em> cannot make progress. This is the problem which QUIC solves in general, but which is reintroduced by HPACK when the loss includes a HEADERS frame.</p>
<h2 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#overview-hol-avoidance" id="overview-hol-avoidance">Avoiding Head-of-Line Blocking in HTTP/QUIC</a>
</h2>
<p id="rfc.section.1.2.p.1">In the example above, the second stream contained a reference to data which might not yet have been processed by the recipient.  Such references are called &#8220;vulnerable,&#8221; because the loss of a different packet can keep the reference from being usable.</p>
<p id="rfc.section.1.2.p.2">The encoder can choose on a per-header-block basis whether to favor higher compression ratio (by permitting vulnerable references) or HoL resilience (by avoiding them).</p>
<p id="rfc.section.1.2.p.3">The header block contains a Base Index (see <a href="#absolute-index" class="xref">Section 2.5.1</a>) which is used to correctly index entries, regardless of reordering in the transport (see <a href="#indexing" class="xref">Section 2.2</a>).  The stream for a header is considered blocked by the decoder and cannot be processed until the greatest absolute index in the dynamic table is at least the value of the Base Index.  While blocked, header field data MUST remain in the blocked stream&#8217;s flow control window.  When the Base Index is zero, the frame contains no references to the dynamic table and can always be processed immediately.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#wire-format" id="wire-format">Wire Format</a>
</h1>
<p id="rfc.section.2.p.1">QPACK instructions occur in three locations, each of which uses a separate instruction space:</p>
<p></p>

<ul>
<li>Table updates are carried by HEADERS frames on the control stream, as defined by <a href="#QUIC-HTTP" class="xref">[QUIC-HTTP]</a>.  Frames on this stream modify the dynamic table state without generating output to any particular request.</li>
<li>Acknowledgement of header frame processing is carried by HEADER_ACK frames on the control stream, running from decoder to encoder.</li>
<li>Finally, the contents of HEADERS and PUSH_PROMISE frames on request streams reference the QPACK table state.</li>
</ul>
<p id="rfc.section.2.p.3">This section describes the instructions which are possible on each stream type.</p>
<p id="rfc.section.2.p.4">In order to ensure table consistency and simplify update management, all table updates occur on the control stream rather than on request streams. Request streams contain only header blocks, which do not modify the state of the table.</p>
<h2 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#primitives" id="primitives">Primitives</a>
</h2>
<p id="rfc.section.2.1.p.1">The prefixed integer from Section 5.1 of <a href="#RFC7541" class="xref">[RFC7541]</a> is used heavily throughout this document.  The string literal, defined by Section 5.2 of <a href="#RFC7541" class="xref">[RFC7541]</a>, is used with the following modification.</p>
<p id="rfc.section.2.1.p.2">HPACK defines string literals to begin on a byte boundary.  They begin with a single flag (indicating whether the string is Huffman-coded), followed by the Length encoded as a 7-bit prefix integer, and finally Length octets of data.</p>
<p id="rfc.section.2.1.p.3">QPACK permits strings to begin other than on a byte boundary.  An &#8220;N-bit prefix string literal&#8221; begins with the same Huffman flag, followed by the length encoded as an (N-1)-bit prefix integer.  The remainder of the string literal is unmodified.</p>
<p id="rfc.section.2.1.p.4">A string literal without a prefix length noted is an 8-bit prefix string literal and follows the definitions in <a href="#RFC7541" class="xref">[RFC7541]</a> without modification.</p>
<h2 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#indexing" id="indexing">Indexing</a>
</h2>
<p id="rfc.section.2.2.p.1">Entries in the QPACK static and dynamic tables are addressed separately.</p>
<p id="rfc.section.2.2.p.2">Entries in the static table have the same indices at all times.  The static table is defined in Appendix A of <a href="#RFC7541" class="xref">[RFC7541]</a>. Note that because HPACK did not use zero-based references, there is no value at index zero of the static table.</p>
<p id="rfc.section.2.2.p.3">Entries are inserted into the dynamic table over time.  Each entry possesses both an absolute index which is fixed for the lifetime of that entry and a relative index which changes over time based on the context of the reference.  The first entry inserted has an absolute index of &#8220;1&#8221;; indices increase sequentially with each insertion.</p>
<p id="rfc.section.2.2.p.4">On the control stream, a relative index of &#8220;0&#8221; always refers to the most recently inserted value in the dynamic table.  Note that this means the entry referenced by a given relative index can change while interpreting a HEADERS frame as new entries are inserted.</p>
<pre>
    +---+---------------+-------+
    | n |      ...      | d + 1 |  Absolute Index
    + - +---------------+   -   +
    | 0 |      ...      | n-d-1 |  Relative Index
    +---+---------------+-------+
      ^                     |
      |                     V
Insertion Point         Dropping Point

n = count of entries inserted
d = count of entries dropped
</pre>
<p class="figure">Example Dynamic Table Indexing - Control Stream</p>
<p id="rfc.section.2.2.p.5">Because frames from request streams can be delivered out of order with instructions on the control stream, relative indices are relative to the Base Index at the beginning of the header block (see <a href="#absolute-index" class="xref">Section 2.5.1</a>). The Base Index is the absolute index of the entry which has the relative index of zero when interpreting the frame.  The relative indices of entries do not change while interpreting headers on a request or push stream.</p>
<pre>
             Base Index
                 |
                 V
    +---+-----+-----+-----+-------+
    | n | n-1 | n-2 | ... |  d+1  |  Absolute Index
    +---+-----+  -  +-----+   -   +
              |  0  | ... | n-d-3 |  Relative Index
              +-----+-----+-------+

n = count of entries inserted
d = count of entries dropped
</pre>
<p class="figure">Example Dynamic Table Indexing - Request Stream</p>
<p id="rfc.section.2.2.p.6">Entries with an absolute index greater than a frame&#8217;s Base Index cannot be referenced by that frame.  If the decoder encounters a reference to an entry which has already been dropped from the table, this MUST be treated as a stream error of type <samp>HTTP_QPACK_DECOMPRESSION_FAILED</samp>.  If this reference occurs on the control stream, this MUST be treated as a connection error.</p>
<h2 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> <a href="#headers-frames-on-the-control-stream" id="headers-frames-on-the-control-stream">HEADERS Frames on the Control Stream</a>
</h2>
<p id="rfc.section.2.3.p.1">Table updates can add a table entry, possibly using existing entries to avoid transmitting redundant information.  The name can be transmitted as a reference to an existing entry in the static or the dynamic table or as a string literal.  For entries which already exist in the dynamic table, the full entry can also be used by reference, creating a duplicate entry.</p>
<h3 id="rfc.section.2.3.1">
<a href="#rfc.section.2.3.1">2.3.1.</a> <a href="#insert-with-name-reference" id="insert-with-name-reference">Insert With Name Reference</a>
</h3>
<p id="rfc.section.2.3.1.p.1">An addition to the header table where the header field name matches the header field name of an entry stored in the static table or the dynamic table starts with the &#8216;1&#8217; one-bit pattern.  The <samp>S</samp> bit indicates whether the reference is to the static (S=1) or dynamic (S=0) table. The header field name is represented using the relative index of that entry, which is represented as an integer with a 6-bit prefix (see Section 5.1 of <a href="#RFC7541" class="xref">[RFC7541]</a>).</p>
<p id="rfc.section.2.3.1.p.2">The header name reference is followed by the header field value represented as a string literal (see Section 5.2 of <a href="#RFC7541" class="xref">[RFC7541]</a>).</p>
<pre>
     0   1   2   3   4   5   6   7
   +---+---+---+---+---+---+---+---+
   | 1 | S |    Name Index (6+)    |
   +---+---+-----------------------+
   | H |     Value Length (7+)     |
   +---+---------------------------+
   | Value String (Length octets)  |
   +-------------------------------+
</pre>
<p class="figure">Insert Header Field -- Indexed Name</p>
<h3 id="rfc.section.2.3.2">
<a href="#rfc.section.2.3.2">2.3.2.</a> <a href="#insert-without-name-reference" id="insert-without-name-reference">Insert Without Name Reference</a>
</h3>
<p id="rfc.section.2.3.2.p.1">An addition to the header table where both the header field name and the header field value are represented as string literals (see <a href="#primitives" class="xref">Section 2.1</a>) starts with the &#8216;01&#8217; two-bit pattern.</p>
<p id="rfc.section.2.3.2.p.2">The name is represented as a 6-bit prefix string literal, while the value is represented as an 8-bit prefix string literal.</p>
<pre>
     0   1   2   3   4   5   6   7
   +---+---+---+---+---+---+---+---+
   | 0 | 1 | H | Name Length (5+)  |
   +---+---+---+-------------------+
   |  Name String (Length octets)  |
   +---+---------------------------+
   | H |     Value Length (7+)     |
   +---+---------------------------+
   | Value String (Length octets)  |
   +-------------------------------+
</pre>
<p class="figure">Insert Header Field -- New Name</p>
<h3 id="rfc.section.2.3.3">
<a href="#rfc.section.2.3.3">2.3.3.</a> <a href="#indexed-duplicate" id="indexed-duplicate">Duplicate</a>
</h3>
<p id="rfc.section.2.3.3.p.1">Duplication of an existing entry in the dynamic table starts with the &#8216;000&#8217; three-bit pattern.  The relative index of the existing entry is represented as an integer with a 5-bit prefix.</p>
<div id="rfc.figure.1"></div>
<div id="fig-index-with-duplication"></div>
<pre>
     0   1   2   3   4   5   6   7
   +---+---+---+---+---+---+---+---+
   | 0 | 0 | 0 |    Index (5+)     |
   +---+---+---+-------------------+
</pre>
<p class="figure">Figure 1: Duplicate</p>
<p id="rfc.section.2.3.3.p.2">The existing entry is re-inserted into the dynamic table without resending either the name or the value. This is useful to mitigate the eviction of older entries which are frequently referenced, both to avoid the need to resend the header and to avoid the entry in the table blocking the ability to insert new headers.</p>
<h3 id="rfc.section.2.3.4">
<a href="#rfc.section.2.3.4">2.3.4.</a> <a href="#dynamic-table-size-update" id="dynamic-table-size-update">Dynamic Table Size Update</a>
</h3>
<p id="rfc.section.2.3.4.p.1">An encoder informs the decoder of a change to the size of the dynamic table using an instruction which begins with the &#8216;001&#8217; three-bit pattern.  The new maximum table size is represented as an integer with a 5-bit prefix (see Section 5.1 of <a href="#RFC7541" class="xref">[RFC7541]</a>).</p>
<div id="rfc.figure.2"></div>
<div id="fig-size-change"></div>
<pre>
  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 | 0 | 1 |   Max size (5+)   |
+---+---+---+-------------------+
</pre>
<p class="figure">Figure 2: Maximum Dynamic Table Size Change</p>
<p id="rfc.section.2.3.4.p.2">The new maximum size MUST be lower than or equal to the limit determined by the protocol using QPACK.  A value that exceeds this limit MUST be treated as a decoding error.  In HTTP/QUIC, this limit is the value of the SETTINGS_HEADER_TABLE_SIZE parameter (see <a href="#QUIC-HTTP" class="xref">[QUIC-HTTP]</a>) received from the decoder.</p>
<p id="rfc.section.2.3.4.p.3">Reducing the maximum size of the dynamic table can cause entries to be evicted (see Section 4.3 of <a href="#RFC7541" class="xref">[RFC7541]</a>).  This MUST NOT cause the eviction of entries with outstanding references (see <a href="#reference-tracking" class="xref">Section 3.1</a>).</p>
<h2 id="rfc.section.2.4">
<a href="#rfc.section.2.4">2.4.</a> <a href="#feedback" id="feedback">HEADER_ACK Frames</a>
</h2>
<p id="rfc.section.2.4.p.1">HEADER_ACK frames on the control stream carry information used to ensure consistency of the dynamic table. Information is sent from the QPACK decoder to the QPACK encoder; that is, the server informs the client about the processing of the client&#8217;s header blocks and table updates, and the client informs the server about the processing of the server&#8217;s header blocks and table updates.</p>
<p id="rfc.section.2.4.p.2">Each frame represents a header block or table update which the QPACK decoder has fully processed.  It is used by the peer&#8217;s QPACK encoder to determine whether subsequent indexed representations that might reference impacted entries are vulnerable to head-of-line blocking, and to prevent eviction races.</p>
<p id="rfc.section.2.4.p.3">The frame payload contains contains a variable-length integer (as defined in <a href="#QUIC-TRANSPORT" class="xref">[QUIC-TRANSPORT]</a>) which indicates the stream on which the header block was processed. The same Stream ID can be identified in multiple frames, as multiple header blocks can be sent on a single request or push stream.  (Requests can have trailers; responses can have intermediate status codes and PUSH_PROMISE frames.) As the control stream carries multiple table updates, the control stream can also be identified in multiple frames.</p>
<p id="rfc.section.2.4.p.4">Since header frames on each stream are received and processed in order, this gives the encoder precise feedback on which header blocks within a stream have been fully processed.</p>
<h2 id="rfc.section.2.5">
<a href="#rfc.section.2.5">2.5.</a> <a href="#request-streams" id="request-streams">Request Streams</a>
</h2>
<p id="rfc.section.2.5.p.1">HEADERS and PUSH_PROMISE frames on request and push streams reference the dynamic table in a particular state without modifying it, but emit the headers for an HTTP request or response.</p>
<h3 id="rfc.section.2.5.1">
<a href="#rfc.section.2.5.1">2.5.1.</a> <a href="#absolute-index" id="absolute-index">Base Index Encoding</a>
</h3>
<p id="rfc.section.2.5.1.p.1">Header data is prefixed by an 8-bit prefix integer: <samp>Base Index</samp>.  <samp>Base Index</samp> is used to resolve references in the dynamic table as described in <a href="#indexing" class="xref">Section 2.2</a>.</p>
<div id="rfc.figure.3"></div>
<div id="fig-base-index"></div>
<pre>
  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
|        Base Index (8+)        |
+-------------------------------+
|      Compressed Headers     ...
+-------------------------------+
</pre>
<p class="figure">Figure 3: Frame Payload</p>
<p id="rfc.section.2.5.1.p.2">Base Index is also used to identify header dependencies (see <a href="#overview-hol-avoidance" class="xref">Section 1.2</a>).</p>
<h3 id="rfc.section.2.5.2">
<a href="#rfc.section.2.5.2">2.5.2.</a> <a href="#instructions" id="instructions">Instructions</a>
</h3>
<h4 id="rfc.section.2.5.2.1">
<a href="#rfc.section.2.5.2.1">2.5.2.1.</a> <a href="#indexed-header-field" id="indexed-header-field">Indexed Header Field</a>
</h4>
<p id="rfc.section.2.5.2.1.p.1">An indexed header field representation identifies an entry in either the static table or the dynamic table and causes that header field to be added to the decoded header list, as described in Section 3.2 of <a href="#RFC7541" class="xref">[RFC7541]</a>.</p>
<pre>
  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 1 | S |      Index (6+)       |
+---+---+-----------------------+
</pre>
<p class="figure">Indexed Header Field</p>
<p id="rfc.section.2.5.2.1.p.2">An indexed header field starts with the &#8216;1&#8217; 1-bit pattern, followed by the <samp>S</samp> bit indicating whether the reference is into the static (S=1) or dynamic (S=0) table. Finally, the relative index of the matching header field is represented as an integer with a 6-bit prefix (see Section 5.1 of <a href="#RFC7541" class="xref">[RFC7541]</a>).</p>
<h4 id="rfc.section.2.5.2.2">
<a href="#rfc.section.2.5.2.2">2.5.2.2.</a> <a href="#literal-header-field-with-name-reference" id="literal-header-field-with-name-reference">Literal Header Field With Name Reference</a>
</h4>
<p id="rfc.section.2.5.2.2.p.1">A header where the header field name matches the header field name of an entry stored in the static table or the dynamic table starts with the &#8216;00&#8217; two-bit pattern.</p>
<p id="rfc.section.2.5.2.2.p.2">The third bit, &#8216;N&#8217;, indicates whether an intermediary is permitted to add this header to the dynamic header table on subsequent hops. When the &#8216;N&#8217; bit is set, the encoded header MUST always be encoded with a literal representation. In particular, when a peer sends a header field that it received represented as a literal header field with the &#8216;N&#8217; bit set, it MUST use a literal representation to forward this header field.  This bit is intended for protecting header field values that are not to be put at risk by compressing them (see Section 7.1 of <a href="#RFC7541" class="xref">[RFC7541]</a> for more details).</p>
<p id="rfc.section.2.5.2.2.p.3">The header field name is represented using the relative index of that entry, which is represented as an integer with a 4-bit prefix (see Section 5.1 of <a href="#RFC7541" class="xref">[RFC7541]</a>). The <samp>S</samp> bit indicates whether the reference is to the static (S=1) or dynamic (S=0) table.</p>
<pre>
     0   1   2   3   4   5   6   7
   +---+---+---+---+---+---+---+---+
   | 0 | 0 | N | S |Name Index (4+)|
   +---+---+-----------------------+
   | H |     Value Length (7+)     |
   +---+---------------------------+
   | Value String (Length octets)  |
   +-------------------------------+
</pre>
<p class="figure">Literal Header Field With Name Reference</p>
<h4 id="rfc.section.2.5.2.3">
<a href="#rfc.section.2.5.2.3">2.5.2.3.</a> <a href="#literal-header-field-without-name-reference" id="literal-header-field-without-name-reference">Literal Header Field Without Name Reference</a>
</h4>
<p id="rfc.section.2.5.2.3.p.1">An addition to the header table where both the header field name and the header field value are represented as string literals (see <a href="#primitives" class="xref">Section 2.1</a>) starts with the &#8216;01&#8217; two-bit pattern.</p>
<p id="rfc.section.2.5.2.3.p.2">The third bit, &#8216;N&#8217;, indicates whether an intermediary is permitted to add this header to the dynamic header table on subsequent hops. When the &#8216;N&#8217; bit is set, the encoded header MUST always be encoded with a literal representation. In particular, when a peer sends a header field that it received represented as a literal header field with the &#8216;N&#8217; bit set, it MUST use a literal representation to forward this header field.  This bit is intended for protecting header field values that are not to be put at risk by compressing them (see Section 7.1 of <a href="#RFC7541" class="xref">[RFC7541]</a> for more details).</p>
<p id="rfc.section.2.5.2.3.p.3">The name is represented as a 5-bit prefix string literal, while the value is represented as an 8-bit prefix string literal.</p>
<pre>
     0   1   2   3   4   5   6   7
   +---+---+---+---+---+---+---+---+
   | 0 | 1 | N | H |Name Length(4+)|
   +---+---+---+-------------------+
   |  Name String (Length octets)  |
   +---+---------------------------+
   | H |     Value Length (7+)     |
   +---+---------------------------+
   | Value String (Length octets)  |
   +-------------------------------+
</pre>
<p class="figure">Literal Header Field Without Name Reference</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#encoding-strategies" id="encoding-strategies">Encoding Strategies</a>
</h1>
<p id="rfc.section.3.p.1">Due to out-of-order arrival, QPACK&#8217;s eviction algorithm requires changes (relative to HPACK) to avoid the possibility that an indexed representation is decoded after the referenced entry has already been evicted.  QPACK employs a two-phase eviction algorithm, in which the encoder will not evict entries that have outstanding (unacknowledged) references.</p>
<h2 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#reference-tracking" id="reference-tracking">Reference Tracking</a>
</h2>
<p id="rfc.section.3.1.p.1">An encoder MUST ensure that a header block which references a dynamic table entry is not received by the decoder after the referenced entry has already been evicted, and MUST ensure that the decoder will not suffer head-of-line blocking if the decoder has not opted to receive blocking references. Even if the decoder is willing to process blocking references, the encoder might choose to avoid them in certain cases.</p>
<p id="rfc.section.3.1.p.2">In order to enable this, the encoder will need to track outstanding (unacknowledged) header blocks and table updates using feedback received from the decoder.</p>
<h3 id="rfc.section.3.1.1">
<a href="#rfc.section.3.1.1">3.1.1.</a> <a href="#blocked-eviction" id="blocked-eviction">Blocked Eviction</a>
</h3>
<p id="rfc.section.3.1.1.p.1">The encoder MUST NOT emit an instruction that evicts an entry while a reference to that entry remains unacknowledged. When the encoder encounters a blocked eviction, it SHOULD emit a literal representation for the new header, and MAY insert the header into the table later if desired.</p>
<p id="rfc.section.3.1.1.p.2">To ensure that blocked evictions are rare, the encoder SHOULD avoid referencing any eviction-prone entries, which are dynamic table entries that might be evicted soon.  Rather than reference an eviction-prone entry, the encoder SHOULD emit an Indexed-Duplicate representation (see <a href="#indexed-duplicate" class="xref">Section 2.3.3</a>), and reference the duplicate instead.</p>
<p id="rfc.section.3.1.1.p.3">To identify eviction-prone entries, the encoder can maintain a draining index, which is the smallest absolute index in the dynamic table that it will emit a reference for.  As new entries are inserted, the encoder increments the draining index such that the amount of free and draining space in the dyanmic table is larger than its target threshold.</p>
<div id="rfc.figure.4"></div>
<div id="fig-eviction-prone"></div>
<pre>
   +----------------+-----------------------+------------+
   | Eviction-prone |     Referenceable     | Free Space |
   |    Entries     |        Entries        |            |
   +----------------+-----------------------+------------+
   ^                ^                       ^
   |                |                       |
 Drop Point    Draining Index           Base Index /
                                      Insertion Point
</pre>
<p class="figure">Figure 4: Encoder's View of Dynamic Table with draining index</p>
<h3 id="rfc.section.3.1.2">
<a href="#rfc.section.3.1.2">3.1.2.</a> <a href="#blocked-decoding" id="blocked-decoding">Blocked Decoding</a>
</h3>
<p id="rfc.section.3.1.2.p.1">For header blocks encoded in non-blocking mode, the encoder needs to forego indexed representations that refer to table updates which have not yet been acknowledged with <a href="#feedback" class="xref">Section 2.4</a>.</p>
<p id="rfc.section.3.1.2.p.2">To track blocked streams, the necessary Base Index value for each stream can be used.  Whenever the decoder processes a table update, it can begin decoding any blocked streams that now have their dependencies satisfied.</p>
<h2 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#speculative-updates" id="speculative-updates">Speculative table updates</a>
</h2>
<p id="rfc.section.3.2.p.1">Implementations can <em>speculatively</em> send header frames on the HTTP Control Streams which are not needed for any current HTTP request or response.  Such headers could be used strategically to improve performance.  For instance, the encoder might decide to <em>refresh</em> by sending Indexed-Duplicate representations for popular header fields (<a href="#indexed-duplicate" class="xref">Section 2.3.3</a>), ensuring they have small indices and hence minimal size on the wire.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.4.p.1">TBD.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.5.p.1">None.</p>
<h1 id="rfc.references">
<a href="#rfc.references">6.</a> References</h1>
<h2 id="rfc.references.1">
<a href="#rfc.references.1">6.1.</a> Normative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="QUIC-HTTP">[QUIC-HTTP]</b></td>
<td class="top">
<a>Bishop, M.</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-http-11">Hypertext Transfer Protocol (HTTP) over QUIC</a>", Internet-Draft draft-ietf-quic-http-11, April 2018.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7541">[RFC7541]</b></td>
<td class="top">
<a>Peon, R.</a> and <a>H. Ruellan</a>, "<a href="https://tools.ietf.org/html/rfc7541">HPACK: Header Compression for HTTP/2</a>", RFC 7541, DOI 10.17487/RFC7541, May 2015.</td>
</tr>
</tbody></table>
<h2 id="rfc.references.2">
<a href="#rfc.references.2">6.2.</a> Informative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="QUIC-TRANSPORT">[QUIC-TRANSPORT]</b></td>
<td class="top">
<a>Iyengar, J.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-transport-11">QUIC: A UDP-Based Multiplexed and Secure Transport</a>", Internet-Draft draft-ietf-quic-transport-11, April 2018.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7540">[RFC7540]</b></td>
<td class="top">
<a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
</tr>
</tbody></table>
<h1 id="rfc.acknowledgments"><a href="#rfc.acknowledgments">Acknowledgments</a></h1>
<p id="rfc.section.A.p.1">This draft draws heavily on the text of <a href="#RFC7541" class="xref">[RFC7541]</a>.  The indirect input of those authors is gratefully acknowledged, as well as ideas from:</p>
<p></p>

<ul>
<li>Ryan Hamilton</li>
<li>Patrick McManus</li>
<li>Kazuho Oku</li>
<li>Biren Roy</li>
<li>Ian Swett</li>
<li>Dmitri Tikhonov</li>
</ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Charles 'Buck' Krasic</span> 
	  <span class="n hidden">
		<span class="family-name">Krasic</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ckrasic@google.com">ckrasic@google.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mike Bishop</span> 
	  <span class="n hidden">
		<span class="family-name">Bishop</span>
	  </span>
	</span>
	<span class="org vcardline">Akamai Technologies</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mbishop@evequefou.be">mbishop@evequefou.be</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Alan Frindell</span> (editor)
	  <span class="n hidden">
		<span class="family-name">Frindell</span>
	  </span>
	</span>
	<span class="org vcardline">Facebook</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:afrind@fb.com">afrind@fb.com</a></span>

  </address>
</div>

</body>
</html>
